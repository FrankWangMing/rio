{"version":3,"file":"query.js","sourceRoot":"","sources":["../../src/editor/query.tsx"],"names":[],"mappings":"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","sourcesContent":["import {\r\n  QueryCallbacksFor,\r\n  ERROR_NOT_IN_RESOLVER,\r\n  getDOMInfo,\r\n  deprecationWarning,\r\n  DEPRECATED_ROOT_NODE,\r\n  ROOT_NODE,\r\n} from '@rioe/utils';\r\nimport React from 'react';\r\nimport invariant from 'tiny-invariant';\r\n\r\nimport { EventHelpers } from './EventHelpers';\r\nimport { NodeHelpers } from './NodeHelpers';\r\n\r\nimport findPosition from '../events/findPosition';\r\nimport {\r\n  NodeId,\r\n  EditorState,\r\n  Indicator,\r\n  Node,\r\n  Options,\r\n  NodeEventTypes,\r\n  NodeInfo,\r\n  NodeSelector,\r\n  NodeTree,\r\n  SerializedNodes,\r\n  SerializedNode,\r\n  FreshNode,\r\n} from '../interfaces';\r\nimport { createNode } from '../utils/createNode';\r\nimport { deserializeNode } from '../utils/deserializeNode';\r\nimport { fromEntries } from '../utils/fromEntries';\r\nimport { getNodesFromSelector } from '../utils/getNodesFromSelector';\r\nimport { mergeTrees } from '../utils/mergeTrees';\r\nimport { parseNodeFromJSX } from '../utils/parseNodeFromJSX';\r\nimport { resolveComponent } from '../utils/resolveComponent';\r\n\r\nexport function QueryMethods(state: EditorState) {\r\n  const options = state && state.options;\r\n\r\n  const _: () => QueryCallbacksFor<typeof QueryMethods> = () =>\r\n    QueryMethods(state) as any;\r\n\r\n  return {\r\n    /**\r\n     * Determine the best possible location to drop the source Node relative to the target Node\r\n     *\r\n     * TODO: replace with Positioner.computeIndicator();\r\n     */\r\n    getDropPlaceholder: (\r\n      source: NodeSelector,\r\n      target: NodeId,\r\n      pos: { x: number; y: number },\r\n      nodesToDOM: (node: Node) => HTMLElement = (node) =>\r\n        state.nodes[node.id].dom\r\n    ) => {\r\n      const targetNode = state.nodes[target],\r\n        isTargetCanvas = _().node(targetNode.id).isCanvas();\r\n\r\n      const targetParent = isTargetCanvas\r\n        ? targetNode\r\n        : state.nodes[targetNode.data.parent];\r\n\r\n      if (!targetParent) return;\r\n\r\n      const targetParentNodes = targetParent.data.nodes || [];\r\n\r\n      const dimensionsInContainer = targetParentNodes\r\n        ? targetParentNodes.reduce((result, id: NodeId) => {\r\n            const dom = nodesToDOM(state.nodes[id]);\r\n            if (dom) {\r\n              const info: NodeInfo = {\r\n                id,\r\n                ...getDOMInfo(dom),\r\n              };\r\n\r\n              result.push(info);\r\n            }\r\n            return result;\r\n          }, [] as NodeInfo[])\r\n        : [];\r\n\r\n      const dropAction = findPosition(\r\n        targetParent,\r\n        dimensionsInContainer,\r\n        pos.x,\r\n        pos.y\r\n      );\r\n      const currentNode =\r\n        targetParentNodes.length &&\r\n        state.nodes[targetParentNodes[dropAction.index]];\r\n\r\n      const output: Indicator = {\r\n        placement: {\r\n          ...dropAction,\r\n          currentNode,\r\n        },\r\n        error: null,\r\n      };\r\n\r\n      const sourceNodes = getNodesFromSelector(state.nodes, source);\r\n\r\n      sourceNodes.forEach(({ node, exists }) => {\r\n        // If source Node is already in the editor, check if it's draggable\r\n        if (exists) {\r\n          _()\r\n            .node(node.id)\r\n            .isDraggable((err) => (output.error = err));\r\n        }\r\n      });\r\n\r\n      // Check if source Node is droppable in target\r\n      _()\r\n        .node(targetParent.id)\r\n        .isDroppable(source, (err) => (output.error = err));\r\n\r\n      return output;\r\n    },\r\n\r\n    /**\r\n     * Get the current Editor options\r\n     */\r\n    getOptions(): Options {\r\n      return options;\r\n    },\r\n\r\n    getNodes() {\r\n      return state.nodes;\r\n    },\r\n\r\n    /**\r\n     * Helper methods to describe the specified Node\r\n     * @param id\r\n     */\r\n    node(id: NodeId) {\r\n      return NodeHelpers(state, id);\r\n    },\r\n\r\n    /**\r\n     * Returns all the `nodes` in a serialized format\r\n     */\r\n    getSerializedNodes(): SerializedNodes {\r\n      const nodePairs = Object.keys(state.nodes).map((id: NodeId) => [\r\n        id,\r\n        this.node(id).toSerializedNode(),\r\n      ]);\r\n      return fromEntries(nodePairs);\r\n    },\r\n\r\n    getEvent(eventType: NodeEventTypes) {\r\n      return EventHelpers(state, eventType);\r\n    },\r\n\r\n    /**\r\n     * Retrieve the JSON representation of the editor's Nodes\r\n     */\r\n    serialize(): string {\r\n      return JSON.stringify(this.getSerializedNodes());\r\n    },\r\n\r\n    parseReactElement: (reactElement: React.ReactElement) => ({\r\n      toNodeTree(\r\n        normalize?: (node: Node, jsx: React.ReactElement) => void\r\n      ): NodeTree {\r\n        let node = parseNodeFromJSX(reactElement, (node, jsx) => {\r\n          const name = resolveComponent(state.options.resolver, node.data.type);\r\n\r\n          node.data.displayName = node.data.displayName || name;\r\n          node.data.name = name;\r\n\r\n          if (normalize) {\r\n            normalize(node, jsx);\r\n          }\r\n        });\r\n\r\n        let childrenNodes: NodeTree[] = [];\r\n\r\n        if (reactElement.props && reactElement.props.children) {\r\n          childrenNodes = React.Children.toArray(\r\n            reactElement.props.children\r\n          ).reduce<NodeTree[]>((accum, child: any) => {\r\n            if (React.isValidElement(child)) {\r\n              accum.push(_().parseReactElement(child).toNodeTree(normalize));\r\n            }\r\n            return accum;\r\n          }, []);\r\n        }\r\n\r\n        return mergeTrees(node, childrenNodes);\r\n      },\r\n    }),\r\n\r\n    parseSerializedNode: (serializedNode: SerializedNode) => ({\r\n      toNode(normalize?: (node: Node) => void): Node {\r\n        const data = deserializeNode(serializedNode, state.options.resolver);\r\n        invariant(data.type, ERROR_NOT_IN_RESOLVER);\r\n\r\n        const id = typeof normalize === 'string' && normalize;\r\n\r\n        if (id) {\r\n          deprecationWarning(`query.parseSerializedNode(...).toNode(id)`, {\r\n            suggest: `query.parseSerializedNode(...).toNode(node => node.id = id)`,\r\n          });\r\n        }\r\n\r\n        return _()\r\n          .parseFreshNode({\r\n            ...(id ? { id } : {}),\r\n            data,\r\n          })\r\n          .toNode(!id && normalize);\r\n      },\r\n    }),\r\n\r\n    parseFreshNode: (node: FreshNode) => ({\r\n      toNode(normalize?: (node: Node) => void): Node {\r\n        return createNode(node, (node) => {\r\n          if (node.data.parent === DEPRECATED_ROOT_NODE) {\r\n            node.data.parent = ROOT_NODE;\r\n          }\r\n\r\n          const name = resolveComponent(state.options.resolver, node.data.type);\r\n          invariant(name !== null, ERROR_NOT_IN_RESOLVER);\r\n          node.data.displayName = node.data.displayName || name;\r\n          node.data.name = name;\r\n\r\n          if (normalize) {\r\n            normalize(node);\r\n          }\r\n        });\r\n      },\r\n    }),\r\n\r\n    createNode(reactElement: React.ReactElement, extras?: any) {\r\n      deprecationWarning(`query.createNode(${reactElement})`, {\r\n        suggest: `query.parseReactElement(${reactElement}).toNodeTree()`,\r\n      });\r\n\r\n      const tree = this.parseReactElement(reactElement).toNodeTree();\r\n\r\n      const node = tree.nodes[tree.rootNodeId];\r\n\r\n      if (!extras) {\r\n        return node;\r\n      }\r\n\r\n      if (extras.id) {\r\n        node.id = extras.id;\r\n      }\r\n\r\n      if (extras.data) {\r\n        node.data = {\r\n          ...node.data,\r\n          ...extras.data,\r\n        };\r\n      }\r\n\r\n      return node;\r\n    },\r\n\r\n    getState() {\r\n      return state;\r\n    },\r\n  };\r\n}\r\n"]}